import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { createClient } from '@supabase/supabase-js';
import { motion } from 'framer-motion';
import { Loader2, CheckCircle2, Search, AlertCircle } from 'lucide-react';
import { sanitizeInput, validateVerificationCode, sanitizeUrlParams } from '../utils/security';

// Validate environment variables
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
const baseUrl = window.location.origin;

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error(
    'Please connect to Supabase using the "Connect to Supabase" button in the top right corner.'
  );
}

const supabase = createClient(supabaseUrl, supabaseAnonKey);

interface DiplomaData {
  codigo_verificacao: string;
  nome: string;
  curso: string;
  instituicao: string;
  data_emissao: string;
  qr_code_url: string;
}

const DiplomaIcon: React.FC<React.SVGProps<SVGSVGElement>> = (props) => {
  return (
    <svg width="105" height="77" viewBox="0 0 105 77" fill="none" xmlns="http://www.w3.org/2000/svg" {...props}>
      <rect x="1.66212" y="1.66212" width="101.676" height="73.6758" rx="3.32425" fill="white" stroke="#111d7d" strokeWidth="3.32425" strokeLinecap="round" strokeLinejoin="round"/>
      <path d="M25.9735 1.66187C25.9735 0.744045 26.7176 0 27.6354 0H30.3906C31.3084 0 32.0525 0.744045 32.0525 1.66187C32.0525 2.5797 31.3084 3.32374 30.3906 3.32374H27.6354C26.7176 3.32374 25.9735 2.5797 25.9735 1.66187Z" fill="#111d7d"/>
      <path d="M35.3684 1.66187C35.3684 0.744045 36.1125 0 37.0303 0H39.7855C40.7033 0 41.4474 0.744045 41.4474 1.66187C41.4474 2.5797 40.7033 3.32374 39.7855 3.32374H37.0303C36.1125 3.32374 35.3684 2.5797 35.3684 1.66187Z" fill="#111d7d"/>
      <rect x="30.3945" width="9.39474" height="3.32374" fill="#FEFEFE"/>
      <path d="M25.9735 1.66187C25.9735 0.744045 26.7176 0 27.6354 0H30.3906C31.3084 0 32.0525 0.744045 32.0525 1.66187C32.0525 2.5797 31.3084 3.32374 30.3906 3.32374H27.6354C26.7176 3.32374 25.9735 2.5797 25.9735 1.66187Z" fill="#111d7d"/>
      <path d="M35.3684 1.66187C35.3684 0.744045 36.1125 0 37.0303 0H39.7855C40.7033 0 41.4474 0.744045 41.4474 1.66187C41.4474 2.5797 40.7033 3.32374 39.7855 3.32374H37.0303C36.1125 3.32374 35.3684 2.5797 35.3684 1.66187Z" fill="#111d7d"/>
      <mask id="path-7-inside-1" fill="white">
        <path fillRule="evenodd" clipRule="evenodd" d="M8.56581 13.8489C11.7705 13.8489 14.3684 11.2447 14.3684 8.03235C14.3684 7.9395 14.3663 7.84716 14.362 7.75537H90.2451C90.1369 8.19921 90.0796 8.66302 90.0796 9.14025C90.0796 12.3526 92.6775 14.9568 95.8822 14.9568C96.358 14.9568 96.8205 14.8994 97.263 14.7911V62.2089C96.8205 62.1006 96.358 62.0432 95.8822 62.0432C92.6775 62.0432 90.0796 64.6474 90.0796 67.8597C90.0796 68.337 90.1369 68.8008 90.2451 69.2446H14.203C14.3111 68.8008 14.3684 68.337 14.3684 67.8597C14.3684 64.6474 11.7705 62.0432 8.56581 62.0432C8.47312 62.0432 8.38094 62.0454 8.28931 62.0497V13.8424C8.38094 13.8467 8.47312 13.8489 8.56581 13.8489Z"/>
      </mask>
      <path d="M14.362 7.75537V4.98516C13.6048 4.98516 12.8807 5.29508 12.3579 5.84284C11.8352 6.3906 11.5594 7.12845 11.5948 7.88478L14.362 7.75537ZM90.2451 7.75537L92.9365 8.41118C93.1378 7.5852 92.9486 6.71256 92.4235 6.04404C91.8983 5.37552 91.0952 4.98516 90.2451 4.98516V7.75537ZM97.263 14.7911H100.033C100.033 13.9405 99.6424 13.1371 98.9733 12.6119C98.3041 12.0867 97.4308 11.8981 96.6046 12.1003L97.263 14.7911ZM97.263 62.2089L96.6046 64.8997C97.4308 65.1019 98.3042 64.9132 98.9733 64.3881C99.6424 63.8629 100.033 63.0595 100.033 62.2089H97.263ZM90.2451 69.2446V72.0148C91.0952 72.0148 91.8983 71.6244 92.4234 70.9559C92.9486 70.2874 93.1378 69.4148 92.9365 68.5888L90.2451 69.2446ZM14.203 69.2446L11.5115 68.5888C11.3103 69.4148 11.4994 70.2874 12.0246 70.9559C12.5498 71.6244 13.3528 72.0148 14.203 72.0148V69.2446ZM8.28931 62.0497H5.5191C5.5191 62.807 5.82913 63.5313 6.37705 64.054C6.92498 64.5768 7.66303 64.8524 8.41948 64.8168L8.28931 62.0497ZM8.28931 13.8424L8.41944 11.0753C7.66299 11.0397 6.92495 11.3153 6.37704 11.8381C5.82912 12.3608 5.5191 13.0851 5.5191 13.8424H8.28931Z" fill="#111d7d" mask="url(#path-7-inside-1)"/>
      <path d="M65.7206 21.8883C66.5674 21.8883 67.2536 21.2173 67.2536 20.3894C67.2536 19.5615 66.5674 18.8905 65.7206 18.8905H39.8557C39.0089 18.8905 38.3226 19.5615 38.3226 20.3894C38.3226 21.2173 39.0089 21.8883 39.8557 21.8883H65.7206Z" fill="#111d7d"/>
      <path d="M18.7898 30.4885C18.7898 31.3164 19.476 31.9874 20.3228 31.9874H85.2529C86.0997 31.9874 86.786 31.3164 86.786 30.4885C86.786 29.6606 86.0997 28.9896 85.2529 28.9896H20.3228C19.476 28.9896 18.7898 29.6606 18.7898 30.4885Z" fill="#1351B410"/>
      <path d="M20.3228 42.0863H85.2529C86.0997 42.0863 86.786 41.4153 86.786 40.5874C86.786 39.7595 86.0997 39.0885 85.2529 39.0885H20.3228C19.476 39.0885 18.7898 39.7595 18.7898 40.5874C18.7898 41.4153 19.476 42.0863 20.3228 42.0863Z" fill="#1351B410"/>
      <path d="M20.3228 52.1854H50.0145C50.8613 52.1854 51.5476 51.5144 51.5476 50.6865C51.5476 49.8586 50.8613 49.1876 50.0145 49.1876H20.3228C19.476 49.1876 18.7898 49.8586 18.7898 50.6865C18.7898 51.5144 19.476 52.1854 20.3228 52.1854Z" fill="#1351B410"/>
      <rect x="50.2894" y="66.4749" width="6.03947" height="2.76978" fill="#FEFEFE"/>
      <path d="M47.5264 67.8597C47.5264 67.0949 48.1464 66.4749 48.9113 66.4749H50.0494C50.8142 66.4749 51.4343 67.0949 51.4343 67.8597C51.4343 68.6246 50.8142 69.2446 50.0494 69.2446H48.9113C48.1464 69.2446 47.5264 68.6246 47.5264 67.8597Z" fill="#111d7d"/>
      <path d="M54.7108 67.8597C54.7108 67.0949 55.3309 66.4749 56.0957 66.4749H57.2338C57.9987 66.4749 58.6187 67.0949 58.6187 67.8597C58.6187 68.6246 57.9987 69.2446 57.2338 69.2446H56.0957C55.3309 69.2446 54.7108 68.6246 54.7108 67.8597Z" fill="#111d7d"/>
    </svg>
  );
};

const VerificationCard: React.FC = () => {
  const { protocolo } = useParams();
  const navigate = useNavigate();
  const [code, setCode] = useState('');
  const [isScanning, setIsScanning] = useState(false);
  const [diplomaData, setDiplomaData] = useState<DiplomaData | null>(null);
  const [error, setError] = useState('');
  const [verificationStep, setVerificationStep] = useState<'idle' | 'scanning' | 'success' | 'error'>('idle');

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('pt-BR');
  };

  const generateVerificationUrl = (code: string) => {
    return `${baseUrl}/verificar/${code}`;
  };

  const handleVerify = async (verificationCode: string) => {
    if (!verificationCode.trim()) {
      setError('Por favor, digite um código válido.');
      return;
    }

    // Sanitize and validate the verification code
    const sanitizedCode = sanitizeInput(verificationCode);
    if (!validateVerificationCode(sanitizedCode)) {
      setError('Código de verificação inválido.');
      return;
    }

    setIsScanning(true);
    setError('');
    setVerificationStep('scanning');

    try {
      const { data, error: supabaseError } = await supabase
        .from('diplomas')
        .select('*')
        .eq('codigo_verificacao', sanitizedCode)
        .limit(1);

      if (supabaseError) throw supabaseError;

      if (!data || data.length === 0) {
        throw new Error('Diploma não encontrado');
      }

      const diploma = data[0];
      
      const requiredFields: (keyof DiplomaData)[] = ['codigo_verificacao', 'nome', 'curso', 'instituicao', 'data_emissao', 'qr_code_url'];
      const missingFields = requiredFields.filter(field => !diploma[field]);
      
      if (missingFields.length > 0) {
        throw new Error('Erro no sistema: Dados do diploma incompletos. Por favor, contate o suporte.');
      }

      // Update URL with the verification code if not already there
      if (!protocolo) {
        navigate(`/verificar/${sanitizedCode}`);
      }

      await new Promise(resolve => setTimeout(resolve, 2000));
      setVerificationStep('success');
      await new Promise(resolve => setTimeout(resolve, 1000));
      setDiplomaData(diploma as DiplomaData);
    } catch (err) {
      setVerificationStep('error');
      setError(err instanceof Error ? err.message : 'Erro ao verificar o diploma');
    } finally {
      setIsScanning(false);
    }
  };

  useEffect(() => {
    // Check for protocol in URL params or route params
    const urlParams = new URLSearchParams(window.location.search);
    const urlProtocolo = urlParams.get('protocolo');
    const verificationCode = protocolo || urlProtocolo;
    
    if (verificationCode) {
      setCode(verificationCode);
      handleVerify(verificationCode);
    }
  }, [protocolo]);

  if (diplomaData) {
    const verificationUrl = generateVerificationUrl(diplomaData.codigo_verificacao);

    return (
      <div className="bg-white rounded-lg shadow-md p-8 max-w-2xl mx-auto relative">
        {/* Background SVG */}
        <div 
          className="absolute inset-0 w-full h-full opacity-[0.04] rounded-lg"
          style={{
            backgroundImage: `url("data:image/svg+xml;utf8,<svg version='1.1' xmlns='http://www.w3.org/2000/svg' width='407' height='357'><path d='M0 0 C0.68557983 -0.00067474 1.37115967 -0.00134949 2.07751465 -0.00204468 C13.66783328 0.0160009 24.84169949 0.77632332 36.1875 3.25 C36.96416016 3.41628906 37.74082031 3.58257813 38.54101562 3.75390625 C63.19038596 9.2135699 86.19998719 19.86871463 106.1875 35.25 C107.10660156 35.94480469 108.02570313 36.63960937 108.97265625 37.35546875 C142.92961846 64.01093393 164.08968333 102.40836458 170.5 144.9375 C174.90637521 186.92517144 164.5302689 229.5076611 138.01953125 262.8125 C134.23023399 267.44822126 130.33633388 271.93113195 126.1875 276.25 C125.72827148 276.74032715 125.26904297 277.2306543 124.79589844 277.73583984 C94.89541541 309.58465167 50.78053188 329.61540249 7.05297852 331.3762207 C3.63887001 331.45515239 0.22745844 331.48468629 -3.1875 331.5 C-4.90066406 331.5309375 -4.90066406 331.5309375 -6.6484375 331.5625 C-24.1624265 331.64210904 -40.10754511 325.43901763 -52.8125 313.25 C-64.20616909 301.41169992 -70.53211957 286.8062407 -71.1875 270.3125 C-70.47589006 252.92075302 -64.31463722 238.40242709 -51.8125 226.25 C-51.19890625 225.61578125 -50.5853125 224.9815625 -49.953125 224.328125 C-37.72508521 212.51813785 -21.9282286 209.21305751 -5.57958984 208.57910156 C9.15959626 208.00563332 22.02106905 205.38441096 33.1875 195.0625 C42.22923691 185.24479313 44.78058991 174.56202132 44.52734375 161.66015625 C43.92384821 150.00342699 37.44031203 142.26935372 29.375 134.5625 C15.51720655 124.50880671 -0.36315485 122.27367427 -17.07226562 124.55908203 C-26.58253498 126.26543879 -35.24851034 129.82341833 -43.8125 134.25 C-44.72257812 134.70117188 -45.63265625 135.15234375 -46.5703125 135.6171875 C-59.29649832 142.18434462 -70.1542069 150.95337461 -80.38427734 160.87304688 C-81.65169726 162.09496967 -82.94336299 163.29163226 -84.23828125 164.484375 C-95.71057794 175.32498217 -107.32768456 190.49945218 -110.3125 206.1875 C-111.34043727 211.37106172 -112.53519463 214.23886721 -116.91796875 217.29296875 C-119.99831577 218.84902034 -122.36708479 219.31264391 -125.8125 219.25 C-130.00977077 217.68631089 -132.92599113 215.67104755 -135.8125 212.25 C-139.33407044 201.68528869 -134.59691919 190.69980649 -129.86328125 181.21875 C-122.31869362 166.89773203 -111.91944276 154.90646167 -100.8125 143.25 C-100.08675781 142.47140625 -99.36101562 141.6928125 -98.61328125 140.890625 C-75.01750651 116.29170272 -40.57402606 97.36814186 -6.14453125 96.25390625 C15.02906114 95.9932061 35.60592794 103.21865488 50.94921875 117.984375 C51.68785156 118.73203125 52.42648438 119.4796875 53.1875 120.25 C53.89519531 120.93578125 54.60289062 121.6215625 55.33203125 122.328125 C66.92880431 134.30184861 72.1688993 150.80698427 72.1875 167.25 C71.07274308 186.46435572 63.51530038 201.65385464 50.1875 215.25 C49.52234375 215.95125 48.8571875 216.6525 48.171875 217.375 C35.19261373 230.05702628 17.00607569 235.08256462 -0.69335938 235.48950195 C-12.62760935 235.79313884 -21.97930235 237.12093171 -31.8125 244.25 C-32.8025 244.58 -33.7925 244.91 -34.8125 245.25 C-35.87348718 247.04198535 -35.87348718 247.04198535 -36.8125 249.25 C-37.31007813 250.04792969 -37.80765625 250.84585938 -38.3203125 251.66796875 C-43.86504011 261.16364961 -44.4868193 270.66171079 -42.14453125 281.27734375 C-39.11500191 289.86321512 -33.28057851 296.20598708 -25.16015625 300.21875 C-24.38542969 300.5590625 -23.61070313 300.899375 -22.8125 301.25 C-21.75869141 301.72953125 -21.75869141 301.72953125 -20.68359375 302.21875 C2.9436136 311.09436181 36.91079817 300.97511275 58.8125 291.25 C61.62353356 289.95463058 64.41034611 288.61630799 67.1875 287.25 C68.70730469 286.51136719 68.70730469 286.51136719 70.2578125 285.7578125 C82.06354251 279.66564279 92.6318291 271.42036159 102.1875 262.25 C103.06921875 261.43144531 103.9509375 260.61289062 104.859375 259.76953125 C128.00159166 237.64060373 143.13378715 205.45696241 144.1875 173.25 C144.22746094 172.12722656 144.26742188 171.00445312 144.30859375 169.84765625 C145.00814207 130.63180068 129.95870198 96.42154178 103.1875 68.25 C102.61773437 67.61578125 102.04796875 66.9815625 101.4609375 66.328125 C78.6029376 41.71181741 41.56193953 28.79560881 8.77416992 27.12719727 C-26.37860634 25.95981426 -62.69266877 35.14700272 -90.25 57.8125 C-94.1255286 60.81539302 -97.92798895 61.78466819 -102.8125 61.25 C-107.63339942 58.97599084 -110.53849084 56.07089942 -112.8125 51.25 C-113.31209852 46.6096612 -112.49408903 42.578303 -109.6875 38.8125 C-88.32446839 16.99919372 -53.18925898 5.67912151 -23.8125 1.25 C-22.80159302 1.09748779 -22.80159302 1.09748779 -21.77026367 0.94189453 C-14.54438553 -0.00137892 -7.27668769 0.00645989 0 0 Z' fill='%23000000' transform='translate(136.8125,12.75)'/><path d='M0 0 C23.38149152 20.01124753 37.87673168 46.1393905 42.33984375 76.62451172 C44.58205642 112.83083412 34.89879158 141.66951816 11.46484375 169.31201172 C6.89156114 174.32991902 1.72080864 178.50518549 -3.66015625 182.62451172 C-4.81257813 183.51783203 -4.81257813 183.51783203 -5.98828125 184.42919922 C-22.08293202 196.30858431 -40.06436205 203.05483201 -59.66015625 206.62451172 C-60.37300781 206.75728516 -61.08585938 206.89005859 -61.8203125 207.02685547 C-79.30445003 209.73671118 -79.30445003 209.73671118 -85.34765625 205.87451172 C-89.74879159 201.59232598 -91.44465922 198.98167403 -91.66015625 192.62451172 C-90.32253601 187.98218264 -88.79899364 185.09541603 -84.6652832 182.48803711 C-80.3087685 180.6118661 -75.46224486 180.57941656 -70.78515625 180.18701172 C-50.2381633 178.0689791 -32.94886105 171.58793069 -16.66015625 158.62451172 C-15.96535156 158.09470703 -15.27054688 157.56490234 -14.5546875 157.01904297 C2.36798927 143.3390348 13.01980723 120.9969694 15.33984375 99.62451172 C16.85109217 73.95431995 10.25039793 50.46216959 -6.60375977 30.83935547 C-24.44953624 10.92796299 -48.32065195 1.38361299 -74.5625 -0.59423828 C-96.22080957 -1.30726905 -115.90042523 6.65808019 -134.66015625 16.62451172 C-135.65789062 17.14013672 -136.655625 17.65576172 -137.68359375 18.18701172 C-157.791011 28.78805691 -176.77339289 43.69714701 -192.95703125 59.55810547 C-196.13730138 61.98926573 -198.75304729 62.838599 -202.66015625 63.62451172 C-207.10419938 63.01154025 -209.65907658 61.99646719 -212.53515625 58.62451172 C-215.64424164 54.23521469 -216.02150732 52.04477772 -215.66015625 46.62451172 C-213.67396711 41.66240528 -210.78652656 38.42825647 -206.84765625 34.93701172 C-206.2757959 34.42082275 -205.70393555 33.90463379 -205.11474609 33.37280273 C-198.87279467 27.80769965 -192.32353954 22.67087019 -185.66015625 17.62451172 C-184.79898193 16.96201416 -184.79898193 16.96201416 -183.92041016 16.28613281 C-160.66460183 -1.58137322 -134.32730963 -17.2748053 -105.66015625 -24.37548828 C-104.61867432 -24.63579834 -104.61867432 -24.63579834 -103.55615234 -24.90136719 C-67.73538642 -33.43655322 -28.22889052 -23.38846606 0 0 Z' fill='%23000000' transform='translate(215.66015625,88.37548828125)'/><path d='M0 0 C4.97691788 2.95128826 9.48048221 6.39788433 14 10 C14.53109375 10.41540039 15.0621875 10.83080078 15.609375 11.25878906 C30.77812029 23.20034549 44.80838084 37.25464232 56 53 C56.41652832 53.58281738 56.83305664 54.16563477 57.26220703 54.76611328 C78.16759979 84.33196794 92.16868907 118.8698469 96 155 C96.11085938 156.01449219 96.22171875 157.02898437 96.3359375 158.07421875 C101.39763803 212.59010148 83.80015409 268.58135011 48.93359375 310.75390625 C38.64914837 322.93836464 27.65154374 334.2603195 15 344 C14.11344727 344.70914551 14.11344727 344.70914551 13.20898438 345.43261719 C11.27918397 346.97507768 9.32989238 348.48951234 7.375 350 C6.479021 350.72243896 6.479021 350.72243896 5.56494141 351.45947266 C1.03564309 354.88021009 -3.26346769 356.35990696 -9 356 C-13.66309073 353.5821011 -17.32257161 351.03228516 -19 346 C-19.37379278 340.95379742 -19.17703244 337.99691178 -16 334 C-12.14717102 330.18096776 -7.74243387 327.07124619 -3.375 323.875 C3.04367389 319.10730246 8.86152073 313.8265858 14.63427734 308.30273438 C15.74094667 307.24710557 16.86243866 306.20703086 17.98828125 305.171875 C48.18896719 276.62898328 67.99987464 230.84981945 69.28961182 189.61447144 C69.36912052 185.78427853 69.38473775 181.95591825 69.375 178.125 C69.37445618 177.31596222 69.37391235 176.50692444 69.37335205 175.67337036 C69.28752834 147.77826068 63.261215 122.05358159 51 97 C50.64534668 96.27151855 50.29069336 95.54303711 49.92529297 94.79248047 C44.84387307 84.48106113 38.99504619 75.11318311 32 66 C31.34 65.11570312 30.68 64.23140625 30 63.3203125 C19.22877693 49.47760785 6.23507917 37.19855672 -8 27 C-9.73676871 25.71857323 -11.46674776 24.42785527 -13.1875 23.125 C-14.22970703 22.35542969 -14.22970703 22.35542969 -15.29296875 21.5703125 C-18.44200531 18.6734871 -18.96473994 16.36435397 -19.375 12.125 C-19.24556464 7.78082563 -17.90808213 5.29072451 -15 2 C-10.05919939 -1.56197253 -5.63824234 -2.00305978 0 0 Z' fill='%23000000' transform='translate(261,1)'/><path d='M0 0 C3.27448804 1.78437685 5.5214519 4.24198529 8 7 C8.83144531 7.89976563 9.66289062 8.79953125 10.51953125 9.7265625 C42.53861335 45.40397281 63.7649369 96.97264556 64.23828125 144.93359375 C64.2480751 145.76066833 64.25786896 146.58774292 64.26795959 147.43988037 C64.8084944 204.96731424 48.10772359 258.22970555 10.75 302.625 C10.26668213 303.20540039 9.78336426 303.78580078 9.28540039 304.38378906 C5.83769057 308.38575321 2.17018338 312.20745416 -3.125 313.53125 C-8.14829149 313.44752848 -11.07429503 312.37793219 -15 309 C-17.38713778 306.0558634 -17.96192889 304.34898522 -18.375 300.5625 C-17.75553446 294.67757734 -15.13521569 290.8360577 -11.0625 286.6875 C-0.47267697 275.2022773 7.84661374 261.83695947 15 248 C15.56630127 246.91428711 15.56630127 246.91428711 16.14404297 245.80664062 C30.29652269 218.34430262 37.22440483 188.07352864 37.25 157.25 C37.25067474 156.51801392 37.25134949 155.78602783 37.25204468 155.03186035 C37.23419753 142.80039046 36.44859137 131.00195375 34 119 C33.75056641 117.72672852 33.75056641 117.72672852 33.49609375 116.42773438 C29.5664473 96.82316485 22.4613738 78.57313811 13 61 C12.38640625 59.83339844 11.7728125 58.66679688 11.140625 57.46484375 C3.95682424 44.29948988 -5.35148645 32.6701313 -15.13671875 21.35546875 C-18.28693322 17.37312216 -18.42022903 13.95870253 -18 9 C-13.7565385 1.11928578 -8.83485907 -1.78305957 0 0 Z' fill='%23000000' transform='translate(343,22)'/><path d='M0 0 C4.72163078 -0.20528829 7.81147486 0.56173556 11.75390625 3.16015625 C15.28574247 6.5010824 16.48573032 9.43390219 16.8515625 14.171875 C16.62848324 18.71376878 14.51020781 21.44263938 11.31640625 24.47265625 C7.80320543 26.78622752 4.72746972 27.24647354 0.5859375 27.51953125 C-28.6548425 29.73402986 -55.21480611 41.60866249 -74.75390625 64.0390625 C-82.9849799 74.51624269 -89.07585951 85.81636161 -90.5859375 99.1640625 C-91.91343577 109.46797761 -91.91343577 109.46797761 -96.41015625 113.1640625 C-99.9463635 115.08264303 -103.26261585 115.57582351 -107.24609375 115.16015625 C-110.9634382 113.92820395 -113.57627068 112.07626087 -115.9140625 108.87890625 C-120.13847154 100.25665202 -116.86345441 88.77806217 -113.96484375 80.15771484 C-102.89988396 49.40584629 -78.44596865 26.46524632 -49.57421875 12.12890625 C-33.91089462 4.7612898 -17.17896459 1.22493487 0 0 Z' fill='%23000000' transform='translate(142.24609375,163.83984375)'/></svg>")`,
            backgroundSize: 'contain',
            backgroundPosition: 'center',
            backgroundRepeat: 'no-repeat',
            pointerEvents: 'none'
          }}
        />

        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="flex justify-center md:justify-start">
            <img
              src={diplomaData.qr_code_url}
              alt={`QR Code do diploma de ${diplomaData.nome}`}
              className="w-32 h-32"
            />
          </div>
          
          <div className="md:col-span-2">
            <div className="grid grid-cols-2 gap-4 mb-6">
              <div>
                <h3 className="text-sm font-medium text-gray-500">Nome do Estudante</h3>
                <p className="text-lg font-semibold text-gray-900">{diplomaData.nome}</p>
              </div>
              
              <div>
                <h3 className="text-sm font-medium text-gray-500">Código de Verificação</h3>
                <p className="text-lg text-gray-900">{diplomaData.codigo_verificacao}</p>
              </div>
            </div>
            
            <div className="space-y-4">
              <div>
                <h3 className="text-sm font-medium text-gray-500">Curso</h3>
                <p className="text-lg text-gray-900">{diplomaData.curso}</p>
              </div>
              
              <div>
                <h3 className="text-sm font-medium text-gray-500">Instituição</h3>
                <p className="text-lg text-gray-900">{diplomaData.instituicao}</p>
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <h3 className="text-sm font-medium text-gray-500">Data de Emissão</h3>
                  <p className="text-lg text-gray-900">{formatDate(diplomaData.data_emissao)}</p>
                </div>
                
                <div>
                  <h3 className="text-sm font-medium text-gray-500">Status</h3>
                  <p className="text-lg">
                    <span className="text-green-600 font-medium">Ativo</span>
                  </p>
                </div>
              </div>

              <div>
                <h3 className="text-sm font-medium text-gray-500">Link de Verificação</h3>
                <p className="text-sm text-gray-600 break-all">{verificationUrl}</p>
              </div>
            </div>
          </div>
        </div>
        
        <button
          onClick={() => {
            setDiplomaData(null);
            setCode('');
            setVerificationStep('idle');
            navigate('/');
          }}
          className="mt-6 w-full py-3 rounded-md text-white font-medium bg-[#0048A8] hover:bg-[#003366] transition"
        >
          Voltar
        </button>
      </div>
    );
  }

  return (
    <div className="bg-white rounded-lg shadow-md p-8 max-w-2xl mx-auto relative">
      {/* Background SVG */}
      <div 
        className="absolute inset-0 w-full h-full opacity-[0.04] rounded-lg"
        style={{
          backgroundImage: `url("data:image/svg+xml;utf8,<svg version='1.1' xmlns='http://www.w3.org/2000/svg' width='407' height='357'><path d='M0 0 C0.68557983 -0.00067474 1.37115967 -0.00134949 2.07751465 -0.00204468 C13.66783328 0.0160009 24.84169949 0.77632332 36.1875 3.25 C36.96416016 3.41628906 37.74082031 3.58257813 38.54101562 3.75390625 C63.19038596 9.2135699 86.19998719 19.86871463 106.1875 35.25 C107.10660156 35.94480469 108.02570313 36.63960937 108.97265625 37.35546875 C142.92961846 64.01093393 164.08968333 102.40836458 170.5 144.9375 C174.90637521 186.92517144 164.5302689 229.5076611 138.01953125 262.8125 C134.23023399 267.44822126 130.33633388 271.93113195 126.1875 276.25 C125.72827148 276.74032715 125.26904297 277.2306543 124.79589844 277.73583984 C94.89541541 309.58465167 50.78053188 329.61540249 7.05297852 331.3762207 C3.63887001 331.45515239 0.22745844 331.48468629 -3.1875 331.5 C-4.90066406 331.5309375 -4.90066406 331.5309375 -6.6484375 331.5625 C-24.1624265 331.64210904 -40.10754511 325.43901763 -52.8125 313.25 C-64.20616909 301.41169992 -70.53211957 286.8062407 -71.1875 270.3125 C-70.47589006 252.92075302 -64.31463722 238.40242709 -51.8125 226.25 C-51.19890625 225.61578125 -50.5853125 224.9815625 -49.953125 224.328125 C-37.72508521 212.51813785 -21.9282286 209.21305751 -5.57958984 208.57910156 C9.15959626 208.00563332 22.02106905 205.38441096 33.1875 195.0625 C42.22923691 185.24479313 44.78058991 174.56202132 44.52734375 161.66015625 C43.92384821 150.00342699 37.44031203 142.26935372 29.375 134.5625 C15.51720655 124.50880671 -0.36315485 122.27367427 -17.07226562 124.55908203 C-26.58253498 126.26543879 -35.24851034 129.82341833 -43.8125 134.25 C-44.72257812 134.70117188 -45.63265625 135.15234375 -46.5703125 135.6171875 C-59.29649832 142.18434462 -70.1542069 150.95337461 -80.38427734 160.87304688 C-81.65169726 162.09496967 -82.94336299 163.29163226 -84.23828125 164.484375 C-95.71057794 175.32498217 -107.32768456 190.49945218 -110.3125 206.1875 C-111.34043727 211.37106172 -112.53519463 214.23886721 -116.91796875 217.29296875 C-119.99831577 218.84902034 -122.36708479 219.31264391 -125.8125 219.25 C-130.00977077 217.68631089 -132.92599113 215.67104755 -135.8125 212.25 C-139.33407044 201.68528869 -134.59691919 190.69980649 -129.86328125 181.21875 C-122.31869362 166.89773203 -111.91944276 154.90646167 -100.8125 143.25 C-100.08675781 142.47140625 -99.36101562 141.6928125 -98.61328125 140.890625 C-75.01750651 116.29170272 -40.57402606 97.36814186 -6.14453125 96.25390625 C15.02906114 95.9932061 35.60592794 103.21865488 50.94921875 117.984375 C51.68785156 118.73203125 52.42648438 119.4796875 53.1875 120.25 C53.89519531 120.93578125 54.60289062 121.6215625 55.33203125 122.328125 C66.92880431 134.30184861 72.1688993 150.80698427 72.1875 167.25 C71.07274308 186.46435572 63.51530038 201.65385464 50.1875 215.25 C49.52234375 215.95125 48.8571875 216.6525 48.171875 217.375 C35.19261373 230.05702628 17.00607569 235.08256462 -0.69335938 235.48950195 C-12.62760935 235.79313884 -21.97930235 237.12093171 -31.8125 244.25 C-32.8025 244.58 -33.7925 244.91 -34.8125 245.25 C-35.87348718 247.04198535 -35.87348718 247.04198535 -36.8125 249.25 C-37.31007813 250.04792969 -37.80765625 250.84585938 -38.3203125 251.66796875 C-43.86504011 261.16364961 -44.4868193 270.66171079 -42.14453125 281.27734375 C-39.11500191 289.86321512 -33.28057851 296.20598708 -25.16015625 300.21875 C-24.38542969 300.5590625 -23.61070313 300.899375 -22.8125 301.25 C-21.75869141 301.72953125 -21.75869141 301.72953125 -20.68359375 302.21875 C2.9436136 311.09436181 36.91079817 300.97511275 58.8125 291.25 C61.62353356 289.95463058 64.41034611 288.61630799 67.1875 287.25 C68.70730469 286.51136719 68.70730469 286.51136719 70.2578125 285.7578125 C82.06354251 279.66564279 92.6318291 271.42036159 102.1875 262.25 C103.06921875 261.43144531 103.9509375 260.61289062 104.859375 259.76953125 C128.00159166 237.64060373 143.13378715 205.45696241 144.1875 173.25 C144.22746094 172.12722656 144.26742188 171.00445312 144.30859375 169.84765625 C145.00814207 130.63180068 129.95870198 96.42154178 103.1875 68.25 C102.61773437 67.61578125 102.04796875 66.9815625 101.4609375 66.328125 C78.6029376 41.71181741 41.56193953 28.79560881 8.77416992 27.12719727 C-26.37860634 25.95981426 -62.69266877 35.14700272 -90.25 57.8125 C-94.1255286 60.81539302 -97.92798895 61.78466819 -102.8125 61.25 C-107.63339942 58.97599084 -110.53849084 56.07089942 -112.8125 51.25 C-113.31209852 46.6096612 -112.49408903 42.578303 -109.6875 38.8125 C-88.32446839 16.99919372 -53.18925898 5.67912151 -23.8125 1.25 C-22.80159302 1.09748779 -22.80159302 1.09748779 -21.77026367 0.94189453 C-14.54438553 -0.00137892 -7.27668769 0.00645989 0 0 Z' fill='%23000000' transform='translate(136.8125,12.75)'/><path d='M0 0 C23.38149152 20.01124753 37.87673168 46.1393905 42.33984375 76.62451172 C44.58205642 112.83083412 34.89879158 141.66951816 11.46484375 169.31201172 C6.89156114 174.32991902 1.72080864 178.50518549 -3.66015625 182.62451172 C-4.81257813 183.51783203 -4.81257813 183.51783203 -5.98828125 184.42919922 C-22.08293202 196.30858431 -40.06436205 203.05483201 -59.66015625 206.62451172 C-60.37300781 206.75728516 -61.08585938 206.89005859 -61.8203125 207.02685547 C-79.30445003 209.73671118 -79.30445003 209.73671118 -85.34765625 205.87451172 C-89.74879159 201.59232598 -91.44465922 198.98167403 -91.66015625 192.62451172 C-90.32253601 187.98218264 -88.79899364 185.09541603 -84.6652832 182.48803711 C-80.3087685 180.6118661 -75.46224486 180.57941656 -70.78515625 180.18701172 C-50.2381633 178.0689791 -32.94886105 171.58793069 -16.66015625 158.62451172 C-15.96535156 158.09470703 -15.27054688 157.56490234 -14.5546875 157.01904297 C2.36798927 143.3390348 13.01980723 120.9969694 15.33984375 99.62451172 C16.85109217 73.95431995 10.25039793 50.46216959 -6.60375977 30.83935547 C-24.44953624 10.92796299 -48.32065195 1.38361299 -74.5625 -0.59423828 C-96.22080957 -1.30726905 -115.90042523 6.65808019 -134.66015625 16.62451172 C-135.65789062 17.14013672 -136.655625 17.65576172 -137.68359375 18.18701172 C-157.791011 28.78805691 -176.77339289 43.69714701 -192.95703125 59.55810547 C-196.13730138 61.98926573 -198.75304729 62.838599 -202.66015625 63.62451172 C-207.10419938 63.01154025 -209.65907658 61.99646719 -212.53515625 58.62451172 C-215.64424164 54.23521469 -216.02150732 52.04477772 -215.66015625 46.62451172 C-213.67396711 41.66240528 -210.78652656 38.42825647 -206.84765625 34.93701172 C-206.2757959 34.42082275 -205.70393555 33.90463379 -205.11474609 33.37280273 C-198.87279467 27.80769965 -192.32353954 22.67087019 -185.66015625 17.62451172 C-184.79898193 16.96201416 -184.79898193 16.96201416 -183.92041016 16.28613281 C-160.66460183 -1.58137322 -134.32730963 -17.2748053 -105.66015625 -24.37548828 C-104.61867432 -24.63579834 -104.61867432 -24.63579834 -103.55615234 -24.90136719 C-67.73538642 -33.43655322 -28.22889052 -23.38846606 0 0 Z' fill='%23000000' transform='translate(215.66015625,88.37548828125)'/><path d='M0 0 C4.97691788 2.95128826 9.48048221 6.39788433 14 10 C14.53109375 10.41540039 15.0621875 10.83080078 15.609375 11.25878906 C30.77812029 23.20034549 44.80838084 37.25464232 56 53 C56.41652832 53.58281738 56.83305664 54.16563477 57.26220703 54.76611328 C78.16759979 84.33196794 92.16868907 118.8698469 96 155 C96.11085938 156.01449219 96.22171875 157.02898437 96.3359375 158.07421875 C101.39763803 212.59010148 83.80015409 268.58135011 48.93359375 310.75390625 C38.64914837 322.93836464 27.65154374 334.2603195 15 344 C14.11344727 344.70914551 14.11344727 344.70914551 13.20898438 345.43261719 C11.27918397 346.97507768 9.32989238 348.48951234 7.375 350 C6.479021 350.72243896 6.479021 350.72243896 5.56494141 351.45947266 C1.03564309 354.88021009 -3.26346769 356.35990696 -9 356 C-13.66309073 353.5821011 -17.32257161 351.03228516 -19 346 C-19.37379278 340.95379742 -19.17703244 337.99691178 -16 334 C-12.14717102 330.18096776 -7.74243387 327.07124619 -3.375 323.875 C3.04367389 319.10730246 8.86152073 313.8265858 14.63427734 308.30273438 C15.74094667 307.24710557 16.86243866 306.20703086 17.98828125 305.171875 C48.18896719 276.62898328 67.99987464 230.84981945 69.28961182 189.61447144 C69.36912052 185.78427853 69.38473775 181.95591825 69.375 178.125 C69.37445618 177.31596222 69.37391235 176.50692444 69.37335205 175.67337036 C69.28752834 147.77826068 63.261215 122.05358159 51 97 C50.64534668 96.27151855 50.29069336 95.54303711 49.92529297 94.79248047 C44.84387307 84.48106113 38.99504619 75.11318311 32 66 C31.34 65.11570312 30.68 64.23140625 30 63.3203125 C19.22877693 49.47760785 6.23507917 37.19855672 -8 27 C-9.73676871 25.71857323 -11.46674776 24.42785527 -13.1875 23.125 C-14.22970703 22.35542969 -14.22970703 22.35542969 -15.29296875 21.5703125 C-18.44200531 18.6734871 -18.96473994 16.36435397 -19.375 12.125 C-19.24556464 7.78082563 -17.90808213 5.29072451 -15 2 C-10.05919939 -1.56197253 -5.63824234 -2.00305978 0 0 Z' fill='%23000000' transform='translate(261,1)'/><path d='M0 0 C3.27448804 1.78437685 5.5214519 4.24198529 8 7 C8.83144531 7.89976563 9.66289062 8.79953125 10.51953125 9.7265625 C42.53861335 45.40397281 63.7649369 96.97264556 64.23828125 144.93359375 C64.2480751 145.76066833 64.25786896 146.58774292 64.26795959 147.43988037 C64.8084944 204.96731424 48.10772359 258.22970555 10.75 302.625 C10.26668213 303.20540039 9.78336426 303.78580078 9.28540039 304.38378906 C5.83769057 308.38575321 2.17018338 312.20745416 -3.125 313.53125 C-8.14829149 313.44752848 -11.07429503 312.37793219 -15 309 C-17.38713778 306.0558634 -17.96192889 304.34898522 -18.375 300.5625 C-17.75553446 294.67757734 -15.13521569 290.8360577 -11.0625 286.6875 C-0.47267697 275.2022773 7.84661374 261.83695947 15 248 C15.56630127 246.91428711 15.56630127 246.91428711 16.14404297 245.80664062 C30.29652269 218.34430262 37.22440483 188.07352864 37.25 157.25 C37.25067474 156.51801392 37.25134949 155.78602783 37.25204468 155.03186035 C37.23419753 142.80039046 36.44859137 131.00195375 34 119 C33.75056641 117.72672852 33.75056641 117.72672852 33.49609375 116.42773438 C29.5664473 96.82316485 22.4613738 78.57313811 13 61 C12.38640625 59.83339844 11.7728125 58.66679688 11.140625 57.46484375 C3.95682424 44.29948988 -5.35148645 32.6701313 -15.13671875 21.35546875 C-18.28693322 17.37312216 -18.42022903 13.95870253 -18 9 C-13.7565385 1.11928578 -8.83485907 -1.78305957 0 0 Z' fill='%23000000' transform='translate(343,22)'/><path d='M0 0 C4.72163078 -0.20528829 7.81147486 0.56173556 11.75390625 3.16015625 C15.28574247 6.5010824 16.48573032 9.43390219 16.8515625 14.171875 C16.62848324 18.71376878 14.51020781 21.44263938 11.31640625 24.47265625 C7.80320543 26.78622752 4.72746972 27.24647354 0.5859375 27.51953125 C-28.6548425 29.73402986 -55.21480611 41.60866249 -74.75390625 64.0390625 C-82.9849799 74.51624269 -89.07585951 85.81636161 -90.5859375 99.1640625 C-91.91343577 109.46797761 -91.91343577 109.46797761 -96.41015625 113.1640625 C-99.9463635 115.08264303 -103.26261585 115.57582351 -107.24609375 115.16015625 C-110.9634382 113.92820395 -113.57627068 112.07626087 -115.9140625 108.87890625 C-120.13847154 100.25665202 -116.86345441 88.77806217 -113.96484375 80.15771484 C-102.89988396 49.40584629 -78.44596865 26.46524632 -49.57421875 12.12890625 C-33.91089462 4.7612898 -17.17896459 1.22493487 0 0 Z' fill='%23000000' transform='translate(142.24609375,163.83984375)'/></svg>")`,
          backgroundSize: 'contain',
          backgroundPosition: 'center',
          backgroundRepeat: 'no-repeat',
          pointerEvents: 'none'
        }}
      />

      <div className="flex flex-col items-center text-center relative">
        <div className="relative w-20 h-20 mb-4">
          {verificationStep === 'idle' && 
            <DiplomaIcon className="w-full h-full" />
          }
          
          {verificationStep === 'scanning' && (
            <motion.div
              animate={{ rotate: 360 }}
              transition={{ duration: 2, repeat: Infinity, ease: "linear" }}
              className="flex items-center justify-center"
            >
              <Search className="w-12 h-12 text-[#0048A8]" />
            </motion.div>
          )}

          {verificationStep === 'success' && (
            <motion.div
              initial={{ scale: 0 }}
              animate={{ scale: 1 }}
              className="flex items-center justify-center"
            >
              <CheckCircle2 className="w-12 h-12 text-green-500" />
            </motion.div>
          )}

          {verificationStep === 'error' && (
            <motion.div
              initial={{ scale: 0 }}
              animate={{ scale: 1 }}
              className="flex items-center justify-center"
            >
              <AlertCircle className="w-12 h-12 text-red-500" />
            </motion.div>
          )}
        </div>

        <h2 className="text-2xl font-bold text-gray-800 mb-1">
          Verificar a conformidade do Diploma
        </h2>
        <p className="text-gray-600 mb-8">
          (IN SESU N°1/2020 e suas alterações)
        </p>

        <div className="w-full max-w-md space-y-6">
          <div className="space-y-4">
            <input
              type="text"
              value={code}
              onChange={(e) => setCode(e.target.value)}
              placeholder="Digite o código aqui..."
              disabled={isScanning}
              className="w-full px-4 py-3 border border-[#0048A8] rounded-md focus:outline-none focus:ring-2 focus:ring-[#0048A8] focus:ring-opacity-50 disabled:bg-gray-100 disabled:cursor-not-allowed"
            />

            {error && (
              <p className="text-red-600 text-sm">{error}</p>
            )}

            <button 
              onClick={() => handleVerify(code)}
              disabled={!code.trim() || isScanning}
              className={`w-full py-3 rounded-md text-white font-medium transition flex items-center justify-center ${
                code.trim() && !isScanning ? 'bg-[#0048A8] hover:bg-[#003366]' : 'bg-gray-400 cursor-not-allowed'
              }`}
            >
              {isScanning ? (
                <>
                  
                  Verificando...
                </>
              ) : (
                'Verificar'
              )}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

export default VerificationCard;